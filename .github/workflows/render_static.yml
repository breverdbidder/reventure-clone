name: Render Static Site

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium
          
      - name: Render Reventure.app to Static HTML
        run: |
          node << 'SCRIPT'
          const { chromium } = require('playwright');
          const fs = require('fs');
          
          (async () => {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext({
              viewport: { width: 1920, height: 1080 },
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            });
            const page = await context.newPage();
            
            console.log('Navigating to reventure.app...');
            await page.goto('https://www.reventure.app/', { 
              waitUntil: 'domcontentloaded',
              timeout: 30000 
            });
            
            console.log('Waiting for content...');
            await page.waitForTimeout(10000);
            
            const html = await page.content();
            fs.writeFileSync('index.html', html);
            console.log('Saved HTML:', html.length, 'bytes');
            
            const bodyText = await page.evaluate(() => document.body.innerText.substring(0, 1000));
            console.log('Body preview:', bodyText);
            
            const images = await page.evaluate(() => {
              return Array.from(document.querySelectorAll('img')).map(img => ({
                src: img.src, alt: img.alt
              })).filter(i => i.src && !i.src.startsWith('data:'));
            });
            console.log('Found', images.length, 'images');
            fs.writeFileSync('images.json', JSON.stringify(images, null, 2));
            
            await page.screenshot({ path: 'screenshot.png', fullPage: true });
            await browser.close();
          })();
          SCRIPT
          
      - name: Download Assets
        run: |
          mkdir -p assets
          
          # Download key assets from reventure.app
          curl -s -o assets/reventure-app-logo.avif https://www.reventure.app/assets/forecast/reventure-app-logo.avif || true
          curl -s -o assets/app-preview-screenshot.webp https://www.reventure.app/app-preview-screenshot.webp || true
          
          # Download images from images.json
          node << 'SCRIPT'
          const fs = require('fs');
          const https = require('https');
          const path = require('path');
          
          const images = JSON.parse(fs.readFileSync('images.json', 'utf8'));
          let downloaded = 0;
          
          for (const img of images.slice(0, 30)) {
            try {
              const url = new URL(img.src);
              if (!url.hostname.includes('reventure')) continue;
              
              const filename = path.basename(url.pathname) || `img_${downloaded}.png`;
              const dest = 'assets/' + filename;
              
              https.get(img.src, (res) => {
                res.pipe(fs.createWriteStream(dest));
                downloaded++;
              });
            } catch (e) {}
          }
          
          setTimeout(() => console.log('Downloaded', downloaded, 'images'), 5000);
          SCRIPT
          
          sleep 10
          ls -la assets/
          
      - name: Process HTML
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          let html = fs.readFileSync('index.html', 'utf8');
          
          // Update asset paths
          html = html.replace(/https:\/\/www\.reventure\.app\/assets\//g, '/assets/');
          html = html.replace(/https:\/\/www\.reventure\.app\//g, '/');
          
          fs.writeFileSync('index.html', html);
          console.log('Processed HTML for static hosting');
          SCRIPT
          
      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git status
          git commit -m "feat: Rendered static HTML from Playwright" || echo "No changes"
          git push
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rendered-site
          path: |
            index.html
            screenshot.png
            images.json
            assets/
